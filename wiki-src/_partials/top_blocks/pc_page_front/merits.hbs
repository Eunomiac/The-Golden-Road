{{!-- Variables to Pass (from PCSheetData):
- `merits`: ProcessedMerit[] array (already processed and formatted)
--}}

{{#*inline "meritCard"}}
  {{#with this as |entry|}}
    <div class="merit-item{{#if isSub}} sub-merit{{/if}}{{#if entry.cssClasses}} {{entry.cssClasses}}{{/if}}" data-merit-key="{{entry.key}}">
      <div class="merit-header" role="button" tabindex="0" aria-expanded="false">
        <div class="merit-name-row">
          <span class="merit-name">{{entry.name}}</span>
          {{#if entry.value}}
            <span class="merit-value dotline">
              {{#each (range 1 entry.value)}}
                <span class="dot full-dot"></span>
              {{/each}}
            </span>
          {{/if}}
        </div>
        {{#if entry.narrative}}
          <div class="merit-narrative">
            {{{entry.narrative}}}
          </div>
        {{/if}}
      </div>
      <div class="merit-content" style="display: none;">
        {{#if entry.effect}}
          <div class="merit-effect">
            {{{inlineLabel entry.effect "Effect:"}}}
          </div>
        {{/if}}
        {{#if entry.drawback}}
          <div class="merit-drawback">
            {{{inlineLabel entry.drawback "Drawback:"}}}
          </div>
        {{/if}}
        {{#if entry.levels}}
          <ul class="merit-levels">
            {{#each (range 1 entry.value)}}
              {{#with (lookup entry.levels (toString this))}}
                <li class="merit-level">
                  <div class="merit-level-effect">
                    {{{inlineLabel effect (meritLevelLabel name ../this)}}}
                  </div>
                  {{#if drawback}}
                    <div class="merit-level-drawback">
                      {{{inlineLabel drawback "Drawback:"}}}
                    </div>
                  {{/if}}
                </li>
              {{/with}}
            {{/each}}
          </ul>
        {{/if}}
        {{#if entry.source}}
          <div class="merit-source">
            {{> _partials/source-citation source=entry.source}}
          </div>
        {{/if}}
      </div>
      {{#if entry.secondaryVariations}}
        <div class="merit-children merit-children--variations" data-variation-group>
          {{#each entry.secondaryVariations}}
            {{> _partials/advantage/variation-card variation=this isSub=true}}
          {{/each}}
        </div>
      {{/if}}
      {{#if entry.secondaryMerits}}
        <div class="merit-children merit-children--merits">
          {{#each entry.secondaryMerits}}
            {{> meritCard this isSub=true}}
          {{/each}}
        </div>
      {{/if}}
    </div>
  {{/with}}
{{/inline}}

<div class="block top-block merits-block">
  <div class="form-label form-label-title">Merits:</div>
  {{#if merits}}
    {{#each merits}}
      {{> meritCard this}}
    {{/each}}
  {{else}}
    <p class="merit-empty">No recorded merits.</p>
  {{/if}}
</div>

<script type="module">
  import { gsap } from "gsap";

  const meritItems = document.querySelectorAll(".merit-item");
  let currentlyOpenItem = null;

  const closePanel = (item) => {
    const itemHeader = item.querySelector(".merit-header");
    const itemContent = item.querySelector(".merit-content");
    const itemNarrative = item.querySelector(".merit-narrative");

    if (!itemHeader || !itemContent) {
      return;
    }

    itemHeader.setAttribute("aria-expanded", "false");

    const contentHeight = itemContent.offsetHeight;
    itemContent.style.height = `${contentHeight}px`;
    itemContent.style.overflow = "hidden";

    const timeline = gsap.timeline({
      onComplete: () => {
        itemContent.style.display = "none";
        itemContent.style.height = "";
        itemContent.style.overflow = "";
      }
    });

    timeline.to(itemContent, {
      opacity: 0,
      height: 0,
      duration: 0.3,
      ease: "power2.in"
    });

    if (itemNarrative) {
      itemNarrative.style.display = "block";
      itemNarrative.style.opacity = "0";
      itemNarrative.style.height = "0";
      itemNarrative.style.overflow = "hidden";

      const narrativeHeight = itemNarrative.scrollHeight;
      timeline.to(itemNarrative, {
        opacity: 1,
        height: narrativeHeight,
        duration: 0.4,
        ease: "power2.out",
        onComplete: () => {
          itemNarrative.style.height = "auto";
          itemNarrative.style.overflow = "";
        }
      }, "-=0.1");
    }

    if (currentlyOpenItem === item) {
      currentlyOpenItem = null;
    }
  };

  const openPanel = (meritItem, header, content, narrative) => {
    if (currentlyOpenItem && currentlyOpenItem !== meritItem) {
      closePanel(currentlyOpenItem);
    }

    currentlyOpenItem = meritItem;
    header.setAttribute("aria-expanded", "true");

    content.style.display = "block";
    content.style.opacity = "0";
    content.style.height = "0";
    content.style.overflow = "hidden";

    const timeline = gsap.timeline();

    if (narrative) {
      const narrativeHeight = narrative.offsetHeight;
      narrative.style.height = `${narrativeHeight}px`;
      narrative.style.overflow = "hidden";

      timeline.to(narrative, {
        opacity: 0,
        height: 0,
        duration: 0.3,
        ease: "power2.in",
        onComplete: () => {
          narrative.style.display = "none";
          narrative.style.height = "";
          narrative.style.overflow = "";
        }
      });
    }

    const contentHeight = content.scrollHeight;
    timeline.to(content, {
      opacity: 1,
      height: contentHeight,
      duration: 0.4,
      ease: "power2.out",
      onComplete: () => {
        content.style.height = "auto";
        content.style.overflow = "";
      }
    }, narrative ? "-=0.1" : 0);
  };

  meritItems.forEach((meritItem) => {
    const header = meritItem.querySelector(".merit-header");
    const content = meritItem.querySelector(".merit-content");
    const narrative = meritItem.querySelector(".merit-narrative");

    if (!header || !content) {
      return;
    }

    const toggleExpanded = () => {
      const isExpanded = header.getAttribute("aria-expanded") === "true";
      if (isExpanded) {
        closePanel(meritItem);
      } else {
        openPanel(meritItem, header, content, narrative);
      }
    };

    header.addEventListener("click", toggleExpanded);
    header.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        toggleExpanded();
      }
    });
  });

  const setupVariationCard = (card) => {
    const header = card.querySelector(".variation-header");
    const content = card.querySelector(".variation-content");
    const narrative = card.querySelector(".variation-narrative");

    if (!header || !content) {
      return;
    }

    const closeVariation = () => {
      header.setAttribute("aria-expanded", "false");

      const contentHeight = content.offsetHeight;
      content.style.height = `${contentHeight}px`;
      content.style.overflow = "hidden";

      const timeline = gsap.timeline({
        onComplete: () => {
          content.style.display = "none";
          content.style.height = "";
          content.style.overflow = "";
        }
      });

      timeline.to(content, {
        opacity: 0,
        height: 0,
        duration: 0.3,
        ease: "power2.in"
      });

      if (narrative) {
        narrative.style.display = "block";
        narrative.style.opacity = "0";
        narrative.style.height = "0";
        narrative.style.overflow = "hidden";

        const narrativeHeight = narrative.scrollHeight;
        timeline.to(narrative, {
          opacity: 1,
          height: narrativeHeight,
          duration: 0.4,
          ease: "power2.out",
          onComplete: () => {
            narrative.style.height = "auto";
            narrative.style.overflow = "";
          }
        }, "-=0.1");
      }
    };

    const openVariation = () => {
      header.setAttribute("aria-expanded", "true");

      content.style.display = "block";
      content.style.opacity = "0";
      content.style.height = "0";
      content.style.overflow = "hidden";

      const timeline = gsap.timeline();

      if (narrative) {
        const narrativeHeight = narrative.offsetHeight;
        narrative.style.height = `${narrativeHeight}px`;
        narrative.style.overflow = "hidden";

        timeline.to(narrative, {
          opacity: 0,
          height: 0,
          duration: 0.3,
          ease: "power2.in",
          onComplete: () => {
            narrative.style.display = "none";
            narrative.style.height = "";
            narrative.style.overflow = "";
          }
        });
      }

      const contentHeight = content.scrollHeight;
      timeline.to(content, {
        opacity: 1,
        height: contentHeight,
        duration: 0.4,
        ease: "power2.out",
        onComplete: () => {
          content.style.height = "auto";
          content.style.overflow = "";
        }
      }, narrative ? "-=0.1" : 0);
    };

    const toggleVariation = () => {
      const isExpanded = header.getAttribute("aria-expanded") === "true";
      if (isExpanded) {
        closeVariation();
      } else {
        openVariation();
      }
    };

    header.addEventListener("click", toggleVariation);
    header.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        toggleVariation();
      }
    });
  };

  document
    .querySelectorAll(".merits-block .variation-entry")
    .forEach((card) => setupVariationCard(card));
</script>
